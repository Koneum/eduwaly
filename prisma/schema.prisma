// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  output          = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Filiere {
  id            String          @id @default(cuid())
  nom           String
  schoolId      String
  school        School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  modules       Module[]
  emplois       EmploiDuTemps[]
  students      Student[]
  feeStructures FeeStructure[]
  workGroups    WorkGroup[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("filieres")
}

model Module {
  id            String          @id @default(cuid())
  nom           String
  type          String
  vh            Int
  semestre      String         @default("S1") // S1 ou S2
  isUeCommune   Boolean         @default(false)
  schoolId      String
  school        School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  filiereId     String?
  filiere       Filiere?        @relation(fields: [filiereId], references: [id])
  emplois       EmploiDuTemps[]
  evaluations   Evaluation[]
  homework      Homework[]
  absences      Absence[]
  documents     Document[]
  attendances   Attendance[]
  workGroups    WorkGroup[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("modules")
}

model EmploiDuTemps {
  id             String      @id @default(cuid())
  titre          String
  dateDebut      DateTime
  dateFin        DateTime
  heureDebut     String
  heureFin       String
  salle          String
  niveau         String      // L1, L2, L3, M1, M2
  semestre       String      // S1, S2, S3, S4, S5, S6
  vh             Int
  joursCours     String     @default("[]") // JSON array: ["LUNDI", "MARDI", ...]
  evaluation     Boolean     @default(false)
  jourEvaluation String?    // "LUNDI", "MARDI", etc.
  ueCommune      Boolean     @default(false)
  schoolId       String
  school         School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  moduleId       String
  module         Module      @relation(fields: [moduleId], references: [id])
  enseignantId   String
  enseignant     Enseignant @relation(fields: [enseignantId], references: [id])
  filiereId      String?
  filiere        Filiere?   @relation(fields: [filiereId], references: [id])
  anneeUnivId    String?
  anneeUniv      AnneeUniversitaire? @relation(fields: [anneeUnivId], references: [id])
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@map("emplois")
}

model Enseignant {
  id            String          @id @default(cuid())
  nom           String
  prenom        String
  titre         String
  telephone     String
  email         String
  schoolId      String
  school        School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  userId        String?         @unique
  user          User?           @relation(fields: [userId], references: [id])
  type          TypeEnseignant
  grade         Grade
  emplois       EmploiDuTemps[]
  homework      Homework[]
  attendances   Attendance[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([email, schoolId])
  @@map("enseignants")
}

model Parametre {
  id                String   @id @default(uuid())
  schoolId          String   @unique
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  chefDepartement  String
  titre            String
  grade            Grade
  synchroniserDate Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model AnneeUniversitaire {
  id        String          @id @default(cuid())
  annee     String         // Format: "2023-2024"
  dateDebut DateTime?      // Date de début de l'année universitaire
  dateFin   DateTime?      // Date de fin de l'année universitaire
  estActive Boolean        @default(false) // Année universitaire active
  schoolId  String
  school    School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  emplois   EmploiDuTemps[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@unique([annee, schoolId])
  @@map("annees_universitaires")
}

// ============================================
// MODÈLES SAAS MULTI-TENANT
// ============================================

// Modèle École (Tenant)
model School {
  id                String               @id @default(cuid())
  name              String
  subdomain         String               @unique
  logo              String?
  address           String?
  phone             String?
  email             String?
  primaryColor      String               @default("#4F46E5")
  secondaryColor    String               @default("#10B981")
  maxStudents       Int                  @default(100)
  maxTeachers       Int                  @default(20)
  isActive          Boolean              @default(true)
  schoolType        SchoolType           @default(UNIVERSITY) // UNIVERSITY ou HIGH_SCHOOL
  
  // Relations
  subscriptionId    String?              @unique
  subscription      Subscription?
  users             User[]
  students          Student[]
  filieres          Filiere[]
  modules           Module[]
  workGroups        WorkGroup[]
  emplois           EmploiDuTemps[]
  enseignants       Enseignant[]
  parametres        Parametre?
  annees            AnneeUniversitaire[]
  feeStructures     FeeStructure[]
  scholarships      Scholarship[]
  issueReports      IssueReport[]
  rooms             Room[]
  classes           Class[]
  documents         Document[]
  announcements     Announcement[]
  
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@map("schools")
}

// Modèle Utilisateur
model User {
  id                String      @id @default(cuid())
  email             String      @unique
  password          String?     // Optional - Better Auth uses Account.password
  name              String
  avatar            String?
  image             String?     // For Better Auth compatibility
  role              UserRole
  schoolId          String?     // Null pour SUPER_ADMIN
  school            School?     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  isActive          Boolean     @default(true)
  emailVerified     Boolean     @default(false)
  lastLoginAt       DateTime?
  
  // Relations
  student           Student?
  parent            Parent?
  enseignant        Enseignant?
  permissions       UserPermission[]
  uploadPermissions UserUploadPermission[]
  
  // Better Auth relations
  sessions          Session[]
  accounts          Account[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([email])
  @@map("users")
}

// Modèle Étudiant
model Student {
  id                String            @id @default(cuid())
  userId            String?           @unique // Null si pas encore enrôlé
  user              User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId          String
  school            School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentNumber     String
  enrollmentId      String            @unique // ID unique pour s'enrôler
  filiereId         String?
  filiere           Filiere?          @relation(fields: [filiereId], references: [id])
  niveau            String            // L1, L2, L3, M1, M2, 10E, 11E, 12E
  dateOfBirth       DateTime?
  placeOfBirth      String?
  address           String?
  phone             String?
  isEnrolled        Boolean           @default(false) // True si l'étudiant a créé son compte
  
  // Relations
  parents           Parent[]          @relation("StudentParents")
  evaluations       Evaluation[]
  absences          Absence[]
  submissions       Submission[]
  payments          StudentPayment[]
  scholarships      Scholarship[]
  attendances       Attendance[]
  workGroupMembers  WorkGroupMember[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([studentNumber, schoolId])
  @@map("students")
}

// Modèle Parent
model Parent {
  id                String      @id @default(cuid())
  userId            String?     @unique // Null si pas encore enrôlé
  user              User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollmentId      String      @unique // ID unique pour s'enrôler (même que l'étudiant)
  phone             String?
  address           String?
  occupation        String?
  isEnrolled        Boolean     @default(false) // True si le parent a créé son compte
  
  // Relations
  students          Student[]   @relation("StudentParents")
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("parents")
}

// Modèle Évaluation/Notes
model Evaluation {
  id                String      @id @default(cuid())
  studentId         String
  student           Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  moduleId          String
  module            Module      @relation(fields: [moduleId], references: [id])
  note              Float
  coefficient       Float       @default(1.0)
  type              String      // "CC", "TP", "Examen", etc.
  date              DateTime
  validated         Boolean     @default(false)
  comment           String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("evaluations")
}

// Modèle Absence
model Absence {
  id                String      @id @default(cuid())
  studentId         String
  student           Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  moduleId          String?
  module            Module?     @relation(fields: [moduleId], references: [id])
  date              DateTime
  period            String?     // "Matin", "Après-midi", "Toute la journée"
  justified         Boolean     @default(false)
  justification     String?
  notifiedParent    Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("absences")
}

// Modèle Devoir
model Homework {
  id                String        @id @default(cuid())
  moduleId          String
  module            Module        @relation(fields: [moduleId], references: [id])
  enseignantId      String
  enseignant        Enseignant    @relation(fields: [enseignantId], references: [id])
  title             String
  description       String
  type              String        // "Devoir", "Projet", "Lecture", "Exercice"
  dueDate           DateTime
  maxPoints         Float?
  
  // Type d'assignation
  assignmentType    String        @default("INDIVIDUAL") // INDIVIDUAL, GROUP
  workGroupId       String?       // Si assigné à un groupe spécifique
  workGroup         WorkGroup?    @relation(fields: [workGroupId], references: [id])
  
  // Fichiers attachés
  fileUrl           String?
  fileName          String?
  fileSize          Int?
  fileType          String?
  
  // Relations
  submissions       Submission[]
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@map("homework")
}

// Modèle Soumission de Devoir
model Submission {
  id                String           @id @default(cuid())
  homeworkId        String
  homework          Homework         @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  studentId         String
  student           Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  content           String?
  fileUrl           String?
  submittedAt       DateTime?
  status            SubmissionStatus @default(PENDING)
  grade             Float?
  feedback          String?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([homeworkId, studentId])
  @@map("submissions")
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  GRADED
}

// ============================================
// SYSTÈME DE PAIEMENT DE SCOLARITÉ
// ============================================

// Structure des Frais (créée par Admin-School)
model FeeStructure {
  id                String            @id @default(cuid())
  schoolId          String
  school            School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name              String            // "Frais de scolarité L1", "Inscription", etc.
  amount            Decimal           @db.Decimal(10, 2)
  type              FeeType
  niveau            String?           // L1, L2, L3, M1, M2 (optionnel)
  filiereId         String?
  filiere           Filiere?          @relation(fields: [filiereId], references: [id])
  academicYear      String            // "2024-2025"
  dueDate           DateTime?
  isActive          Boolean           @default(true)
  
  // Relations
  payments          StudentPayment[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("fee_structures")
}

// Paiements Étudiants (visible par Student, Parent, Admin-School)
model StudentPayment {
  id                String          @id @default(cuid())
  studentId         String
  student           Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  feeStructureId    String
  feeStructure      FeeStructure    @relation(fields: [feeStructureId], references: [id])
  
  // Montants
  amountDue         Decimal         @db.Decimal(10, 2)
  amountPaid        Decimal         @default(0) @db.Decimal(10, 2)
  discountAmount    Decimal         @default(0) @db.Decimal(10, 2) // Réduction/Bourse
  
  // Statut
  status            PaymentStatus
  dueDate           DateTime
  paidAt            DateTime?
  
  // Informations de paiement
  paymentMethod     String?         // "Cash", "Mobile Money", "Virement", "Carte"
  transactionId     String?
  paidBy            String?         // "Student" ou "Parent" (userId)
  receiptUrl        String?
  
  // Notes
  notes             String?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@map("student_payments")
}

// Bourses et Réductions (créées par Admin-School)
model Scholarship {
  id                String          @id @default(cuid())
  studentId         String?
  student           Student?        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  schoolId          String          // École qui a créé la bourse
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  name              String          // "Bourse d'excellence", "Réduction sociale", etc.
  type              ScholarshipType
  amount            Decimal?        @db.Decimal(10, 2) // Montant fixe
  percentage        Float?          // Pourcentage de réduction (0-100)
  
  reason            String          // Raison de la bourse/réduction
  academicYear      String          // "2024-2025"
  
  isActive          Boolean         @default(true)
  approvedBy        String?         // userId de l'admin qui a approuvé
  approvedAt        DateTime?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@map("scholarships")
}

// ============================================
// SYSTÈME D'ABONNEMENT
// ============================================

// Plan d'Abonnement
model Plan {
  id                String          @id @default(cuid())
  name              String
  description       String?
  price             Decimal         @db.Decimal(10, 2)
  interval          String          // "monthly", "yearly"
  maxStudents       Int
  maxTeachers       Int
  features          String          @default("[]") // JSON array
  stripePriceId     String?
  isActive          Boolean         @default(true)
  
  // Relations
  subscriptions     Subscription[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@map("plans")
}

// Abonnement École
model Subscription {
  id                    String              @id @default(cuid())
  schoolId              String              @unique
  school                School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  planId                String
  plan                  Plan                @relation(fields: [planId], references: [id])
  
  status                SubscriptionStatus
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  trialEndsAt           DateTime?
  canceledAt            DateTime?
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@map("subscriptions")
}

// ============================================
// SYSTÈME DE SIGNALEMENT (SUPER-ADMIN)
// ============================================

// Signalement de Problème
model IssueReport {
  id                String          @id @default(cuid())
  schoolId          String
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  reportedBy        String          // userId
  reporterName      String
  reporterEmail     String
  
  title             String
  description       String
  priority          IssuePriority
  status            IssueStatus     @default(OPEN)
  category          IssueCategory
  
  resolvedBy        String?         // Super-Admin userId
  resolvedAt        DateTime?
  resolution        String?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@map("issue_reports")
}

// ============================================
// ANNONCES GLOBALES
// ============================================

model Announcement {
  id                String                @id @default(cuid())
  schoolId          String?               // Null si annonce Super Admin (toutes écoles)
  school            School?               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  authorId          String
  authorName        String
  authorRole        UserRole
  
  title             String
  content           String
  priority          AnnouncementPriority  @default(NORMAL)
  targetAudience    String[]              // ["TEACHER", "STUDENT", "PARENT"] ou ["ALL"]
  
  isActive          Boolean               @default(true)
  publishedAt       DateTime              @default(now())
  expiresAt         DateTime?
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  @@map("announcements")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN      // Administrateur de la plateforme SAAS
  SCHOOL_ADMIN     // Administrateur d'une école spécifique
  MANAGER          // Manager avec permissions personnalisées
  PERSONNEL        // Personnel avec permissions personnalisées
  ASSISTANT        // Assistant avec permissions personnalisées
  SECRETARY        // Secrétaire avec permissions personnalisées
  TEACHER          // Enseignant
  STUDENT          // Étudiant
  PARENT           // Parent d'étudiant
}

enum PaymentStatus {
  PENDING          // En attente
  PAID             // Payé
  OVERDUE          // En retard
  PARTIAL          // Paiement partiel
  CANCELED         // Annulé
}

enum FeeType {
  TUITION          // Frais de scolarité
  REGISTRATION     // Frais d'inscription
  EXAM             // Frais d'examen
  LIBRARY          // Frais de bibliothèque
  SPORT            // Frais sportifs
  TRANSPORT        // Frais de transport
  OTHER            // Autres frais
}

enum ScholarshipType {
  MERIT            // Bourse au mérite
  NEED_BASED       // Bourse sociale
  DISCOUNT         // Réduction
  FULL             // Bourse complète
  PARTIAL          // Bourse partielle
}

enum SubscriptionStatus {
  TRIAL            // Période d'essai
  ACTIVE           // Actif
  PAST_DUE         // Paiement en retard
  CANCELED         // Annulé
  UNPAID           // Non payé
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssueCategory {
  TECHNICAL        // Problème technique
  BILLING          // Problème de facturation
  FEATURE_REQUEST  // Demande de fonctionnalité
  BUG              // Bug
  SUPPORT          // Support général
  OTHER            // Autre
}

enum TypeEnseignant {
  PERMANENT
  VACATAIRE
  ADMINISTRATEUR
}

enum Grade {
  PROFESSEUR
  MAITRE_CONFERENCE
  MAITRE_ASSISTANT
  ASSISTANT
}

enum SchoolType {
  UNIVERSITY      // Université (gestion par salles)
  HIGH_SCHOOL     // Lycée (gestion par classes)
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================
// GESTION DES SALLES ET CLASSES
// ============================================

// Modèle Salle (pour Universités)
model Room {
  id                String          @id @default(cuid())
  name              String          // "Amphi A", "Salle 201", "Lab 1"
  code              String          // "A01", "S201", "L1"
  capacity          Int             // Capacité en nombre d'étudiants
  type              RoomType        // AMPHITHEATER, CLASSROOM, LABORATORY, etc.
  building          String?         // Bâtiment
  floor             String?         // Étage
  equipment         String          @default("[]") // JSON array: ["Projecteur", "Tableau", "Ordinateurs"]
  isAvailable       Boolean         @default(true)
  schoolId          String
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([code, schoolId])
  @@map("rooms")
}

// Modèle Classe (pour Lycées)
model Class {
  id                String          @id @default(cuid())
  name              String          // "Terminale S1", "Première A", "Seconde B"
  code              String          // "TS1", "1A", "2B"
  niveau            String          // "Terminale", "Première", "Seconde"
  capacity          Int             // Capacité en nombre d'élèves
  mainRoom          String?         // Salle principale assignée
  schoolId          String
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([code, schoolId])
  @@map("classes")
}

// ============================================
// BETTER AUTH MODELS
// ============================================

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

enum RoomType {
  AMPHITHEATER    // Amphithéâtre
  CLASSROOM       // Salle de classe
  LABORATORY      // Laboratoire
  COMPUTER_LAB    // Salle informatique
  LIBRARY         // Bibliothèque
  SPORTS_HALL     // Salle de sport
  CONFERENCE      // Salle de conférence
  OTHER           // Autre
}

// ============================================
// DOCUMENTS & RESSOURCES
// ============================================

// Document (pour partage de ressources pédagogiques)
model Document {
  id            String          @id @default(cuid())
  title         String
  description   String?
  fileName      String
  fileUrl       String
  fileSize      Int             // Taille en bytes
  mimeType      String
  category      DocumentCategory
  schoolId      String
  school        School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  moduleId      String?
  module        Module?         @relation(fields: [moduleId], references: [id])
  uploadedBy    String          // userId
  isPublic      Boolean         @default(false) // Visible par tous ou seulement enseignants
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("documents")
}

enum DocumentCategory {
  COURSE          // Cours
  EXERCISE        // Exercice
  EXAM            // Examen
  CORRECTION      // Correction
  PRESENTATION    // Présentation
  VIDEO           // Vidéo
  OTHER           // Autre
}

// ============================================
// PERMISSIONS SYSTEM
// ============================================

// Permission (définit les permissions disponibles)
model Permission {
  id            String            @id @default(cuid())
  name          String            @unique // Ex: "students.view", "students.create"
  description   String            // Description lisible
  category      String            // Ex: "students", "teachers", "finance"
  userPermissions UserPermission[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@map("permissions")
}

// UserPermission (associe les permissions aux utilisateurs)
model UserPermission {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionId  String
  permission    Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  canView       Boolean     @default(false)
  canCreate     Boolean     @default(false)
  canEdit       Boolean     @default(false)
  canDelete     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, permissionId])
  @@map("user_permissions")
}

// ============================================
// MESSAGING SYSTEM
// ============================================

// Conversation (fil de discussion entre utilisateurs)
model Conversation {
  id                String              @id @default(cuid())
  schoolId          String
  subject           String?             // Sujet de la conversation
  type              ConversationType    @default(DIRECT) // DIRECT, GROUP, ANNOUNCEMENT
  
  // Relations
  participants      ConversationParticipant[]
  messages          Message[]
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("conversations")
}

// Participant à une conversation
model ConversationParticipant {
  id                String        @id @default(cuid())
  conversationId    String
  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId            String
  
  // Métadonnées
  lastReadAt        DateTime?     // Dernière lecture
  isArchived        Boolean       @default(false)
  isMuted           Boolean       @default(false)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

// Message dans une conversation
model Message {
  id                String        @id @default(cuid())
  conversationId    String
  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId          String        // userId de l'expéditeur
  senderName        String        // Nom de l'expéditeur (dénormalisé pour performance)
  senderRole        UserRole      // Rôle de l'expéditeur
  
  // Contenu
  content           String        @db.Text
  attachments       String        @default("[]") // JSON array: [{name, url, size, type}]
  
  // Métadonnées
  isRead            Boolean       @default(false)
  readBy            String        @default("[]") // JSON array: [userId1, userId2, ...]
  isEdited          Boolean       @default(false)
  isDeleted         Boolean       @default(false)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

// Notification (système de notifications push)
model Notification {
  id                String            @id @default(cuid())
  userId            String            // Destinataire
  schoolId          String?           // École concernée (optionnel pour SUPER_ADMIN)
  
  // Contenu
  title             String
  message           String            @db.Text
  type              NotificationType
  category          NotificationCategory
  
  // Métadonnées
  isRead            Boolean           @default(false)
  readAt            DateTime?
  
  // Lien d'action (optionnel)
  actionUrl         String?
  actionLabel       String?
  
  // Données additionnelles (JSON)
  metadata          String            @default("{}") // JSON: {studentId, paymentId, etc.}
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([schoolId])
  @@map("notifications")
}

// ============================================
// ENUMS FOR MESSAGING & NOTIFICATIONS
// ============================================

enum ConversationType {
  DIRECT          // Conversation 1-à-1
  GROUP           // Conversation de groupe
  ANNOUNCEMENT    // Annonce (admin → tous)
}

enum NotificationType {
  INFO            // Information générale
  SUCCESS         // Succès
  WARNING         // Avertissement
  ERROR           // Erreur
  REMINDER        // Rappel
}

enum NotificationCategory {
  MESSAGE         // Nouveau message
  PAYMENT         // Paiement
  GRADE           // Note
  ABSENCE         // Absence
  HOMEWORK        // Devoir
  ANNOUNCEMENT    // Annonce
  SYSTEM          // Système
  OTHER           // Autre
}

// ============================================
// ATTENDANCE (Présences)
// ============================================

model Attendance {
  id          String            @id @default(cuid())
  studentId   String
  moduleId    String
  teacherId   String
  date        DateTime
  status      AttendanceStatus
  notes       String?           @db.Text
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  student     Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  module      Module            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  teacher     Enseignant        @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([moduleId])
  @@index([teacherId])
  @@index([date])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// ============================================
// WORK GROUPS (Groupes de Travail)
// ============================================

model WorkGroup {
  id          String            @id @default(cuid())
  name        String
  schoolId    String
  school      School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Contexte du groupe
  moduleId    String?           // Pour université
  module      Module?           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  filiereId   String?           // Pour université
  filiere     Filiere?          @relation(fields: [filiereId], references: [id])
  
  // Créateur du groupe
  createdBy   String            // userId (peut être étudiant ou enseignant)
  creatorRole String            // STUDENT, TEACHER
  
  // Membres
  members     WorkGroupMember[]
  
  // Devoirs assignés à ce groupe
  homework    Homework[]
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([schoolId])
  @@index([moduleId])
  @@index([filiereId])
  @@map("work_groups")
}

model WorkGroupMember {
  id          String      @id @default(cuid())
  groupId     String
  group       WorkGroup   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  studentId   String
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  role        String      @default("MEMBER") // LEADER, MEMBER
  joinedAt    DateTime    @default(now())

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@map("work_group_members")
}

// ============================================
// PERMISSIONS D'UPLOAD PERSONNALISÉES
// ============================================

model UserUploadPermission {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  grantedBy         String   // userId qui a accordé les permissions
  grantedAt         DateTime @default(now())
  customCategories  String[] // Catégories supplémentaires autorisées (JSON array)
  customMaxSizes    Json?    // Tailles max personnalisées par catégorie
  expiresAt         DateTime?
  reason            String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([grantedBy])
  @@map("user_upload_permissions")
}
